<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
  <meta charset="utf-8">
  <title>ComeBackHome</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">

  <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=lez4a7aeq8"></script>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script type="text/javascript" src="../static/assets/MarkerClustering.js"></script>

  <link rel="stylesheet" th:href="@{/static/plugins/bootstrap/bootstrap.min.css}">
  <!--   icon-->
  <link rel="stylesheet" th:href="@{/static/plugins/themify-icons/themify-icons.css}">
  <!--Favicon-->
  <link rel="icon" th:href="@{/static/images/earthguard.png}" type="image/x-icon">
  <!-- fonts -->
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel="stylesheet">
  <!-- Main Stylesheet -->
  <link th:href="@{/static/assets/style.css}" rel="stylesheet" media="screen" />

  <style>
    html, body { width:100%;height:100%;padding:0;margin:0; }
  </style>

</head>

<body onload="javascript:initMap()">
<!-- header -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary" style="padding-top:5px;padding-bottom: 5px;">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">ComeBackHome</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navbarColor01">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/cases/searchCase">실종자 목록/제보</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/cases/new">실종자 등록하기</a>
        </li>

        <li class="nav-item">
          <a sec:authorize="isAuthenticated()" class="nav-link" href="/users/mypage">마이페이지</a>
        </li>

        <li class="nav-item">
          <a sec:authorize="!isAuthenticated()" class="nav-link" href="/users/login">로그인</a>
          <a sec:authorize="isAuthenticated()" class="nav-link" href="/users/logout">로그아웃</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
<!-- /header -->

<!-- call to action -->
<section class="container-fluid" style="height: 100%;">
  <!--  <div class="container-fluid">-->
  <div class="row" style="height: 100%">
    <div class="col-4">
      <div>
        <div class="position-relative">
          <input type="search" class="form-control" placeholder="실종자를 검색해주세요"><i
                class="ti-search search-icon"></i>
        </div>
        <!--        <div class="position-relative">-->
        <!--          <table style="width:40px;">-->
        <!--            <thead>-->
        <!--              <tr>-->
        <!--                <td>실종자 수</td>-->
        <!--                <td>찾은 사람 수</td>-->
        <!--              </tr>-->
        <!--            </thead>-->
        <!--            <tbody>-->
        <!--            <tr>-->
        <!--              <td id="missingNum"></td>-->
        <!--              <td id="findNum"></td>-->
        <!--            </tr>-->
        <!--            </tbody>-->
        <!--          </table>-->

        <!--        </div>-->
      </div>
    </div>
    <div id="map"class ="col-8" style="width:100%;height:100%;padding:0;margin:0;"></div>
    <script>
      var map = new naver.maps.Map("map", {
        zoom: 7,
        center: new naver.maps.LatLng(36.2253017, 127.6460516),
        zoomControl: true,
        zoomControlOptions: {
          position: naver.maps.Position.TOP_LEFT,
          style: naver.maps.ZoomControlStyle.SMALL
        }
      });

      var htmlMarker1 = {
                content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-1.png);background-size:contain;"></div>',
                size: N.Size(40, 40),
                anchor: N.Point(20, 20)
              },
              htmlMarker2 = {
                content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-2.png);background-size:contain;"></div>',
                size: N.Size(40, 40),
                anchor: N.Point(20, 20)
              },
              htmlMarker3 = {
                content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-3.png);background-size:contain;"></div>',
                size: N.Size(40, 40),
                anchor: N.Point(20, 20)
              },
              htmlMarker4 = {
                content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-4.png);background-size:contain;"></div>',
                size: N.Size(40, 40),
                anchor: N.Point(20, 20)
              },
              htmlMarker5 = {
                content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-5.png);background-size:contain;"></div>',
                size: N.Size(40, 40),
                anchor: N.Point(20, 20)
              };


      var markers = [],
              infoWindows =[];

      function initMap() {

        $.ajax({
          type:"get",
          url:"data.json",
          dataType:"json",
          success: function(data){
            console.log("통신성공");
            $.each(data , function(i){
              var x = data[i].missingLat;
              var y = data[i].missingLng;
              var marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(x, y),
                map: map,
                draggable: false
              });



              var picFullPath= "/images/" + data[i].missingPics[0].uploadPath + "/" + data[i].missingPics[0].savedFileName;
              var checkGender = data[i].missingSex;
              var gender;
              if (checkGender === false)
                gender="여성";
              else
                gender="남성";

              var caseId = data[i].caseId;
              var detailUrl = "/cases/detail/"+caseId;

              //클릭하면 해당 사건 출력
              var infoWindow = new naver.maps.InfoWindow({
                content:'<div style="width:200px;height: 200px;text-align:center; overflow:hidden; line-height: 200px; padding-left:10px;padding-right: 10px; padding-bottom: 5px;"><img style="vertical-align: middle" width="150px" height="auto"src='+ picFullPath +'></div>' +
                        '<div style="width:200px;text-align:left;padding-left:10px;padding-right: 10px; padding-bottom: 5px;"><b>실종자: '+ data[i].missingName +'</b></div>' +
                        '<div style="width:200px;text-align:left;padding-left:10px;padding-right: 10px; padding-bottom: 5px;font-size: small;">'+ data[i].missingAge +'세' + '/'+ gender +'</div>' +
                        '<div style="width:200px;text-align:left;padding-left:10px;padding-right: 10px; padding-bottom: 10px;font-size: small;"><a href=' + detailUrl + '>상세보기</a></div>'
              });
              markers.push(marker);
              infoWindows.push(infoWindow);
            });
            console.log(markers);

            //클러스터링
            var markerClustering = new MarkerClustering({
              minClusterSize: 1,
              maxZoom: 8,
              map: map,
              markers: markers,
              disableClickZoom: false,
              gridSize: 120,
              icons: [htmlMarker1, htmlMarker2, htmlMarker3, htmlMarker4, htmlMarker5],
              indexGenerator: [10, 100, 200, 500, 1000],
              stylingFunction: function(clusterMarker, count) {
                $(clusterMarker.getElement()).find('div:first-child').text(count);
              }
            });

            function getClickHandler(seq){
              return function(e) {
                var marker = markers[seq],
                        infoWindow = infoWindows[seq];

                if (infoWindow.getMap()) {
                  infoWindow.close();
                } else {
                  infoWindow.open(map, marker);
                }
              }
            }

            for (var i=0, ii=markers.length; i<ii; i++) {
              console.log(markers[i] , getClickHandler(i));
              naver.maps.Event.addListener(markers[i], 'click', getClickHandler(i));
            }
          },
          error:function(){
            console.log("통신에러");
          }
        })
      }

    </script>
  </div>
  <!--    </div>-->
</section>
<!— /call to action —>



<!—jquiry —>
<script src="/static/plugins/jquery/jquery-1.12.4.js"></script>
<!—Bootstrap JS—>
<script src="/static/plugins/bootstrap/bootstrap.min.js"></script>
<!—match-height JS—>
<script src="/static/plugins/match-height/jquery.matchHeight-min.js"></script>
<!—Main Script—>
<script src="/static/assets/script.js"></script>
</body>

</html>