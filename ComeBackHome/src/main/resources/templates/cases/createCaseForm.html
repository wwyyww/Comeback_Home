<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      layout:decorate="~{layout/layout}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=df3c33f5950a30da0e53e3fcc48cb634&libraries=services"></script>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=lez4a7aeq8&submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.slim.js" integrity="sha256-HwWONEZrpuoh951cQD1ov2HUK5zA5DwJ1DNUXaM6FsY=" crossorigin="anonymous"></script>
    <style>
        ol, ul {
            list-style: none;
        }
        .map__list.etc-store {
            margin-top: 6px;
            height: 375px;
        }
        .map__list {
            overflow-y: auto;
            position: relative;
            margin-top: 10px;
            padding: 0 14px 0 12px;
            height: 470px;
        }
        .box {
            position: relative;
            overflow: hidden;
            padding-left: 354px;
        }
        .area_left {
            padding: 0 21px 0 24px;
            width: 350px;
            height: 500px;
            position: absolute;
            top: 0;
            left: 0;
            box-shadow: 2px 0 4px 0 rgb(0 0 0 / 20%);
            background: #fff;
        }
        .area_right {
            position: relative;
            width: 600px;
            height: 500px;
            background: #f5f5f5;
        }
        .search-box{
            position: relative;
        }

        .search-box .search-box__inp {
            padding: 0 28px 0 28px;
            width: 80%;
            height: 38px;
            border-radius: 24px;
            border: 1px solid #dadde0;
            font-family: Montserrat,-apple-system,NotoSansCJKkr,AppleSDGothicNeo,Roboto,dotum,"돋움",sans-serif;
            font-size: 14px;
            font-weight: 400;
            line-height: 36px;
            color: #99a1a8;
            background: #fff url(https://www.oliveyoung.co.kr/pc-static-root/image/pickup/ico_detail_search.png) 12px 11px no-repeat;
            background-size: 16px 16px;
        }
        .search-top {
            margin-top: 20px;
            background: #fff;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        .search-store__top--noti {
            margin: 10px 0 0 9px;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: normal;
            line-height: 16px;
            color: #506bda;
        }
        div {
            display: block;
        }
        .map-tab {
            height: 37px;
            font-size: 0;
            background-color: #f0f1f4;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0;
            margin-bottom: 0;
        }
        ul.map-tab li{
            /*background: none;*/
            /*color: #222;*/
            /*display: inline-block;*/
            /*padding: 10px 15px;*/
            /*cursor: pointer;*/
        }
        ul.map-tab li.current{
            /*background: #ededed;*/
            /*color: #222;*/
        }
        .map-tab__list:nth-child(1) {
            padding-left: 3px;
        }
        .map-tab__list.current{
            /*display: inherit;*/
        }

        .map-tab__list {
            display: inline-block;
            width: 115px;
            height: 37px;
        }
        .map-tab__list a {
            display: inline-block;
            width: 100%;
            height: 31px;
            line-height: 31px;
            font-size: 13px;
            font-weight: 400;
            text-align: center;
            letter-spacing: 0;
            word-spacing: normal;
            color: #99a1a8;
            margin-top: 3px;
            overflow: hidden;
        }
        a {
            color: #666;
            text-decoration: none;
        }
        #menu_wrap {position:absolute;top:0;left:0;bottom:0;width:300px;margin:90px 0 10px 10px;padding:5px;overflow-y:auto;background:rgba(255, 255, 255, 0.7);z-index: 1;font-size:12px;border-radius: 10px;}
        .bg_white {background:#fff;}
        #menu_wrap hr {display: block; height: 1px;border: 0; border-top: 2px solid #5F5F5F;margin:3px 0;}
        #menu_wrap .option{text-align: center;}
        #menu_wrap .option p {margin:10px 0;}
        #menu_wrap .option button {margin-left:5px;}
        #placesList li {list-style: none;}
        #placesList .item {position:relative;border-bottom:1px solid #888;overflow: hidden;cursor: pointer;min-height: 65px;}
        #placesList .item span {display: block;margin-top:4px;}
        #placesList .item h5, #placesList .item .info {text-overflow: ellipsis;overflow: hidden;white-space: nowrap;}
        #placesList .item .info{padding:10px 0 10px 55px;}
        #placesList .info .gray {color:#8a8a8a;}
        #placesList .info .jibun {padding-left:26px;background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_jibun.png) no-repeat;}
        #placesList .info .tel {color:#009900;}
        #placesList .item .markerbg {float:left;position:absolute;width:36px; height:37px;margin:10px 0 0 10px;background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png) no-repeat;}
        #placesList .item .marker_1 {background-position: 0 -10px;}
        #placesList .item .marker_2 {background-position: 0 -56px;}
        #placesList .item .marker_3 {background-position: 0 -102px}
        #placesList .item .marker_4 {background-position: 0 -148px;}
        #placesList .item .marker_5 {background-position: 0 -194px;}
        #placesList .item .marker_6 {background-position: 0 -240px;}
        #placesList .item .marker_7 {background-position: 0 -286px;}
        #placesList .item .marker_8 {background-position: 0 -332px;}
        #placesList .item .marker_9 {background-position: 0 -378px;}
        #placesList .item .marker_10 {background-position: 0 -423px;}
        #placesList .item .marker_11 {background-position: 0 -470px;}
        #placesList .item .marker_12 {background-position: 0 -516px;}
        #placesList .item .marker_13 {background-position: 0 -562px;}
        #placesList .item .marker_14 {background-position: 0 -608px;}
        #placesList .item .marker_15 {background-position: 0 -654px;}
        #pagination {margin:10px auto;text-align: center;}
        #pagination a {display:inline-block;margin-right:10px;}
        #pagination .on {font-weight: bold; cursor: default;color:#777;}
    </style>
</head>
<body>
<div layout:fragment="content" class="container">
  <form  method="post" enctype="multipart/form-data" id="newCaseForm" onsubmit="return checkFileNull();">
    <div class="form-group">
      <div>
        <label for="missingName">실종자 이름</label>
        <input type="text" id="missingName" name="missingName" th:value="${caseDto.missingName}" placeholder="이름을 입력하세요">
        <span th:text="${valid_missingName}"></span>
      </div>

      <div>
        <label for="missingAge">실종자 나이</label>
        <input type="number" id="missingAge" name="missingAge" min="1" max="150" th:value="${caseDto.missingAge}" > 세
        <span th:text="${valid_missingAge}"></span>
      </div>

      <div>
        <label for="missingSex">실종자 성별</label>
        <label for="man">남자</label>
        <input type="radio" name="missingSex" value=true id="man" th:checked="${caseDto.missingSex eq true}">
        <label for="woman">여자</label>
        <input type="radio" name="missingSex" value=false id="woman" th:checked="${caseDto.missingSex eq false}"/>
        <span th:text="${valid_missingSex}"></span>
    </div>

      <div>
        <label for="missingFeature">실종자 특징  </label>
        <input type="radio" name="missingFeature" value=1 id="1" th:checked="${caseDto.missingFeature eq 1}">
        <label for="missingFeature1">비장애아동(18세 미만)</label>

        <input type="radio" name="missingFeature" value=2 id="2" th:checked="${caseDto.missingFeature eq 2}"/>
        <label for="missingFeature2">장애인</label>

        <input type="radio" name="missingFeature" value=3 id="3" th:checked="${caseDto.missingFeature eq 3}"/>
        <label for="missingFeature3">치매환자</label>

        <input type="radio" name="missingFeature" value=4 id="4" th:checked="${caseDto.missingFeature eq 4}"/>
        <label for="missingFeature4">기타(18세 이상)</label>

        <span th:text="${valid_missingFeature}"></span>
      </div>


      <div>
        <label for="missingDesc">실종자 추가 정보</label>
        <input type="text" id="missingDesc" name="missingDesc" th:value="${caseDto.missingDesc}" placeholder="실종자 인상착의 등 실종자 추가 정보를 적어주세요"  style="width:500px; height:30px">
        <span th:text="${valid_missingDesc}"></span>
      </div>

      <div>
          <label for="missingTimeStart">실종 시간</label>
          <input type="datetime-local" id="missingTimeStart" name="missingTimeStart" th:value="${caseDto.missingTimeStart}"> ~
          <input type="datetime-local" id="missingTimeEnd" name="missingTimeEnd" onchange="setMinValue()" th:value="${caseDto.missingTimeEnd}">
          <span th:text="${valid_missingTimeStart}"></span>
          <span th:text="${valid_missingTimeEnd}"></span>
      </div>

      <script>
        let missingTimeStart = document.getElementById("missingTimeStart");
        let missingTimeEnd = document.getElementById("missingTimeEnd");

        function setMinValue() {
            if( missingTimeStart.value >= missingTimeEnd.value) {
                alert('실종 시간보다 이전의 날짜는 설정할 수 없습니다.');
                missingTimeEnd.value = null;
            }
        }
      </script>

      <div>
          <label for="missingPics">실종자 사진</label>
          <input type="file" id="missingPics" name="missingPics" multiple="multiple" placeholder="사진 경로를 입력하세요">
      </div>

        <p><em>지도를 클릭해주세요!</em></p>
        <!--        <form action="/cases/new" method="post">-->
        <div className="form-group">
            <!--            <div id="clickLatlng"></div>-->
            <input type="hidden" id="missingLat" name="missingLat">
            <input type="hidden" id="missingLng" name="missingLng">
            <input type="text" id="missingArea" name="missingArea"  placeholder="장소를 선택해주세요">
            <!--            <button type="submit">등록</button>-->
        </div>

      <div>
<!--        &lt;!&ndash;장소 검색&ndash;&gt;-->
<!--        <div class="search" style="">-->
<!--          <input id="address" type="text" placeholder="검색할 주소" value="불정로 6" />-->
<!--          <input id="submit" type="button" value="주소 검색" />-->
<!--        </div>-->
        <div class="box">
            <div class="area_left">
<!--                <ul class="map-tab" id="mapTabArea">-->
<!--                    <li class="map-tab__list current" data-tab="searchKeywordTab">키워드 검색</li>-->
<!--                    <li class="map-tab__list" data-tab="searchAreaTab">지역 검색</li>-->
<!--                </ul>-->
                <div class="search-top">
                    <div class="search-box">
                        <input id="address" type="text" class="search-box__inp" name="searchWord" value="" title="주소 입력 (ex. 명동 또는 퇴계로)" placeholder="주소 입력">
                        &nbsp;&nbsp;<input id="submit" type="button" value="검색"/>
                    </div>
                    <p class="search-store__top--noti">실종 지역을 검색하세요</p>
                </div>
                <div>
                    <div id="menu_wrap" class="bg_white">
                        <div class="option">
                            <ul id="placesList"></ul>
                            <div id="pagination"></div>
                        </div>
                    </div>
                </div>

<!--                <div id="searchKeywordTab" class="ListArea">-->
<!--                    <ul id="placesList" class="map__list etc-store"> </ul>-->
<!--                    <div id="pagination"></div>-->
<!--                </div>-->
<!--                <div id="searchAreaTab" class="ListArea">-->
<!--                    <p>지역 검색</p>-->
<!--                </div>-->
                <div>

                </div>
            </div>
<!--            <script>-->
<!--                $(document).ready(function(){-->

<!--                    $('ul.tabs li').click(function(){-->
<!--                        var tab_id = $(this).attr('data-tab');-->
<!--                        $('ul.map-tab li').removeClass('current');-->
<!--                        $('.ListArea').removeClass('current');-->

<!--                        $(this).addClass('current');-->
<!--                        $("#"+tab_id).addClass('current');-->
<!--                    })-->

<!--                })-->
<!--            </script>-->
            <div class="area_right">
                <!-- 지도 표기 -->
                <div id="map" style="width:100%;height:500px;"></div>
            </div>
        </div>



<!--        </form>-->
          <script>
              // 검색결과 목록의 자식 Element를 제거하는 함수입니다
              function removeAllChildNods(el){
                  while(el.hasChildNodes()){
                      el.removeChild(el.lastChild);
                  }
              }

              // 검색결과 목록 하단에 페이지번호를 표시는 함수입니다
              function displayPagination(pagination) {
                  var paginationEl = document.getElementById('pagination'),
                      fragment = document.createDocumentFragment(),
                      i;

                  // 기존에 추가된 페이지번호를 삭제합니다
                  while (paginationEl.hasChildNodes()) {
                      paginationEl.removeChild (paginationEl.lastChild);
                  }

                  for (i=1; i<=pagination.last; i++) {
                      var el = document.createElement('a');
                      el.href = "#";
                      el.innerHTML = i;

                      if (i===pagination.current) {
                          el.className = 'on';
                      } else {
                          el.onclick = (function(i) {
                              return function() {
                                  pagination.gotoPage(i);
                              }
                          })(i);
                      }

                      fragment.appendChild(el);
                  }
                  paginationEl.appendChild(fragment);
              }

              function getListItem(index, places) {

                  var el = document.createElement('li'),
                      itemStr = '<span class="markerbg marker_' + (index+1) + '"></span>' +
                          '<div class="info">' +
                          '   <h5>' + places.place_name + '</h5>';

                  if (places.road_address_name) {
                      itemStr += '    <span>' + places.road_address_name + '</span>' +
                          '   <span class="jibun gray">' +  places.address_name  + '</span>';
                  } else {
                      itemStr += '    <span>' +  places.address_name  + '</span>';
                  }

                  itemStr += '  <span class="tel">' + places.phone  + '</span>' +
                      '</div>';

                  el.innerHTML = itemStr;
                  el.className = 'item';

                  return el;
              }

              function displayPlaces(places){
                  var listEl = document.getElementById('placesList'),
                      menuEl = document.getElementById('menu_wrap'),
                      fragment = document.createDocumentFragment(),
                      listStr = '';
                  // 검색 결과 목록에 추가된 항목들을 제거합니다
                  removeAllChildNods(listEl);

                  for ( var i=0; i<places.length; i++ ) {
                      // 마커를 생성하고 지도에 표시합니다
                      var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x),
                          itemEl = getListItem(i, places[i]); // 검색 결과 항목 Element를 생성합니다

                      // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
                      // LatLngBounds 객체에 좌표를 추가합니다
                      //bounds.extend(placePosition);

                      // 마커와 검색결과 항목에 mouseover 했을때
                      // 해당 장소에 인포윈도우에 장소명을 표시합니다
                      // mouseout 했을 때는 인포윈도우를 닫습니다


                      fragment.appendChild(itemEl);
                  }
                  // 검색결과 항목들을 검색결과 목록 Element에 추가합니다
                  listEl.appendChild(fragment);
                  menuEl.scrollTop = 0;
              }

              //키워드 검색을 요청하는 함수
              function searchPlaces(keyword){
                  console.log("searchPlaces");
                  // 장소 검색 객체를 생성합니다
                  var ps = new kakao.maps.services.Places();
                  // 장소검색 객체를 통해 키워드로 장소검색을 요청합니다.
                  ps.keywordSearch(keyword, placesSearchCB);
              }

              function placesSearchCB (data, status, pagination) {
                  if (status === kakao.maps.services.Status.OK) {
                      for (var i=0; i<data.length; i++) {
                          console.log(data[i].place_name);
                      }
                      displayPlaces(data);
                      displayPagination(pagination);
                      searchAddressToCoordinate(data);

                  } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                      alert('검색 결과가 존재하지 않습니다.');
                      return;
                  } else if (status === kakao.maps.services.Status.ERROR) {

                      alert('검색 결과 중 오류가 발생했습니다.');
                      return;

                  }

              }

              var map = new naver.maps.Map("map", {
                  center: new naver.maps.LatLng(37.3595316, 127.1052133),
                  zoom: 15,
                  mapTypeControl: true
              });

              var infoWindow = new naver.maps.InfoWindow({
                  anchorSkew: true
              });

              map.setCursor('pointer');

              function searchCoordinateToAddress(latlng) { // 경도, 위도를 주소로 변환

                  infoWindow.close();

                  naver.maps.Service.reverseGeocode({
                      coords: latlng,
                      orders: [
                          naver.maps.Service.OrderType.ADDR,
                          naver.maps.Service.OrderType.ROAD_ADDR
                      ].join(',')
                  }, function(status, response) {
                      if (status === naver.maps.Service.Status.ERROR) {
                          if (!latlng) {
                              return alert('ReverseGeocode Error, Please check latlng');
                          }
                          if (latlng.toString) {
                              return alert('ReverseGeocode Error, latlng:' + latlng.toString());
                          }
                          if (latlng.x && latlng.y) {
                              return alert('ReverseGeocode Error, x:' + latlng.x + ', y:' + latlng.y);
                          }
                          return alert('ReverseGeocode Error, Please check latlng');
                      }

                      var address = response.v2.address,
                          htmlAddresses = [];

                      if (address.jibunAddress !== '') {
                          htmlAddresses.push('[지번 주소] ' + address.jibunAddress);
                      }

                      if (address.roadAddress !== '') {
                          htmlAddresses.push('[도로명 주소] ' + address.roadAddress);
                      }

                      infoWindow.setContent([
                          '<div style="padding:10px;min-width:200px;line-height:150%;">',
                          '<h4 style="margin-top:5px;">검색 좌표</h4><br />',
                          htmlAddresses.join('<br />'),
                          '</div>'
                      ].join('\n'));

                      infoWindow.open(map, latlng);
                  });
              }

              function searchAddressToCoordinate(address) {

                  // naver.maps.Service.geocode({
                  //     query: address
                  // }, function(status, response) {
                  //
                  //     if (status === naver.maps.Service.Status.ERROR) {
                  //         if (!address) {
                  //             return alert('Geocode Error, Please check address');
                  //         }
                  //         return alert('Geocode Error, address:' + address);
                  //     }


                      console.log("items: " + address, address[0]);
                      if (address.length === 0) {
                          return alert('No result.');
                      }
                      // if (response.v2.meta.totalCount === 0) {
                      //     return alert('No result.');
                      // }
                      var htmlAddresses = [],
                          item = address[0],
                          point = new naver.maps.Point(item.x, item.y);

                      // var htmlAddresses = [],
                      //     item = response.v2.addresses[0],
                      //     point = new naver.maps.Point(item.x, item.y);


                      if (item.road_address_name) {
                          htmlAddresses.push('[도로명 주소] ' + item.road_address_name);
                      }

                      if (item.address_name) {
                          htmlAddresses.push('[지번 주소] ' + item.address_name);
                      }

                      // if (item.englishAddress) {
                      //     htmlAddresses.push('[영문명 주소] ' + item.englishAddress);
                      // }

                      infoWindow.setContent([
                          '<div style="padding:10px;min-width:100px;line-height:150%;">',
                          '<h4 style="margin-top:5px;">검색 주소 : '+ address[0].place_name +'</h4><br />',
                          htmlAddresses.join('<br />'),
                          '</div>'
                      ].join('\n'));

                      map.setCenter(point);
                      infoWindow.open(map, point);
                  //});
              }

              function initGeocoder() {
                  map.addListener('click', function(e) {
                      searchCoordinateToAddress(e.coord);
                  });

                  $('#address').on('keydown', function(e) {
                      var keyCode = e.which;

                      if (keyCode === 13) { // Enter Key
                          searchAddressToCoordinate($('#address').val());
                      }
                  });

                  $('#submit').on('click', function(e) {
                      e.preventDefault();
                      //searchAddressToCoordinate($('#address').val());
                      searchPlaces($('#address').val());
                  });

                  searchAddressToCoordinate('정자동 178-1');
              }

              naver.maps.onJSContentLoaded = initGeocoder;
          </script>
        <script>
          var position = new naver.maps.LatLng(37.3595704, 127.105399);

          var map = new naver.maps.Map('map', {
            center: position,
            zoom: 15
          });

          var marker = new naver.maps.Marker({
            position: position,
            map: map
          });

          function searchCoordinateToAddress(latlng) {
            naver.maps.Service.reverseGeocode({
              coords: latlng,
              orders: [
                naver.maps.Service.OrderType.ADDR,
                naver.maps.Service.OrderType.ROAD_ADDR
              ].join(',')
            }, function(status, response) {
              if (status === naver.maps.Service.Status.ERROR) {
                if (!latlng) {
                  return alert('ReverseGeocode Error, Please check latlng');
                }
                if (latlng.toString) {
                  return alert('ReverseGeocode Error, latlng:' + latlng.toString());
                }
                if (latlng.x && latlng.y) {
                  return alert('ReverseGeocode Error, x:' + latlng.x + ', y:' + latlng.y);
                }
                return alert('ReverseGeocode Error, Please check latlng');
              }

              var address = response.v2.address,
                  htmlAddresses = [];

              if (address.jibunAddress !== '') {
                htmlAddresses.push('[지번 주소] ' + address.jibunAddress);
              }

              if (address.roadAddress !== '') {
                htmlAddresses.push('[도로명 주소] ' + address.roadAddress);
              }

              missingArea.value = address.jibunAddress;
            });
          }

          function searchAddressToCoordinate(address) {
            naver.maps.Service.geocode({
              query: address
            }, function(status, response) {
              if (status === naver.maps.Service.Status.ERROR) {
                if (!address) {
                  return alert('Geocode Error, Please check address');
                }
                return alert('Geocode Error, address:' + address);
              }

              if (response.v2.meta.totalCount === 0) {
                return alert('No result.');
              }

              var point = new naver.maps.Point(item.x, item.y);

              map.setCenter(point);
            });
          }

          naver.maps.Event.addListener(map, 'click', function(e) {
            marker.setPosition(e.coord);
            // var message = marker.position.toString();
            // var resultDiv = document.getElementById('clickLatlng');
            // resultDiv.innerHTML =  message;

            var missingLat = document.getElementById('missingLat');
            var missingLng = document.getElementById('missingLng');
            var missingArea = document.getElementById('missingArea');
            missingLat.value = marker.position.lat().toString();
            missingLng.value = marker.position.lng().toString();

            searchCoordinateToAddress(marker.position);
          });

          $('#address').on('keydown', function(e) {
            var keyCode = e.which;

            if (keyCode === 13) { // Enter Key
              searchAddressToCoordinate($('#address').val());
            }
          });


        </script>

      </div>

    </div>
    <button type="submit">등록</button>
  </form>
    <script>
      // 파일 null인지 확인
      let missingPics = document.getElementById("missingPics");
      let newCaseForm = document.getElementById("newCaseForm");
      function checkFileNull() {
        if(! missingPics.value) {
          alert("실종자 사진 등록은 필수입니다.");
          return false;
        }
      }
    </script>
</div>

</body>
</html>
