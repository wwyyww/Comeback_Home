<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
  <meta charset="UTF-8">
  <title>사건 상세 페이지</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=lez4a7aeq8&submodules=geocoder"></script>
  <style>
    .layout {
      width: 500px;
      margin: 0 auto;
      margin-top: 40px;
    }

    .layout input {
      width: 100%;
      box-sizing: border-box;
    }

    .layout textarea {
      width: 100%;
      margin-top: 10px;
      min-height: 300px;
    }
  </style>
</head>
<body>
<div layout:fragment="content" class="container">
<table class ="table table-bordered">
  <thead>
  <caption>사건 상세보기</caption>
  </thead>
  <tbody>
  <tr>
    <th>실종자 이름</th>
    <td th:text="${case.getMissingName()}"></td>
  </tr>
  <tbody>
<!--  <tr th:each="pic : ${missing_pics}">-->
  <tr>
    <th>실종자 사진</th>
    <td th:each="imageFile  : ${case.getMissingPics()}">
      <img th:src="@{/images/{filename} (filename=${imageFile.getSavedFileName()})}" width="300" height="300" style="margin-right: 5px"/>
      <a th:href="@{/download/{filename} (filename=${imageFile.getSavedFileName()})}">
        <div th:text="${imageFile.getOrgFileName()}"></div>
      </a>
    </td>
  </tr>
  <tr>
    <th>실종자 나이</th>
    <td th:text="${case.getMissingAge()} + '살'"></td>
  </tr>
  <tr>
    <th>실종자 성별</th>
    <td th:if="${case.getMissingSex() == false}">여자</td>
    <td th:if="${case.getMissingSex() == true}">남자</td>
  </tr>
  <tr>
    <th>실종자 정보</th>
    <td th:text="${case.getMissingDesc()}"></td>
  </tr>
  <tr>
    <th>실종자 지역</th>
    <td th:text="${case.getMissingArea()}"></td>
  </tr>
  <tr>
    <th>실종 시간</th>
    <td>
      <span th:text="${#temporals.format(case.getMissingTimeStart(), 'yyyy-MM-dd HH:MM')}"></span> ~
        <span th:text="${#temporals.format(case.getMissingTimeEnd(), 'yyyy-MM-dd HH:MM')}"></span>
    </td>
  </tr>
  </tbody>
</table>

<div th:unless="${user != null}">
  <a th:href="@{/reports/new/{id}(id=${case.getCaseId()})}">제보하기</a>
</div>

<div th:if="${user != null}">
  <a th:href="@{/cases/detail/{id}/warn (id=${case.getCaseId()})}">사건 신고하기</a>
  <div th:if="${case.getUserId() == user.getId()}">
    <a th:href="@{/cases/detailReport/{id}(id=${case.getCaseId()})}">제보보기</a>
  </div>
  <div th:if="${case.getUserId() != user.getId()}">
    <a th:href="@{/reports/new/{id}(id=${case.getCaseId()})}">제보하기</a>
  </div>

  <div th:if="${case.getUserId() == user.getId()}">
    <a th:href="@{/cases/delete/{id}(id=${case.getCaseId()})}">글 삭제</a>
    <a th:href="@{/cases/update/{id}(id=${case.getCaseId()})}">글 수정</a>

    <div th:unless="${case.getIsFind()}">
      <button th:onclick="|location.href='@{/cases/find/{id} (id=${case.getCaseId()})}'|">실종자 찾음</button>
    </div>
    <div th:if="${case.getIsFind()}">
      <button disabled>실종자 찾음</button>
    </div>

  <form th:action="@{/cases/detail/{id}/submit(id=${case.getCaseId()})}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <div>
      <table>
        <tbody>
          <tr>
            <td>실종 지역</td>
            <td>
              <select name="missing_area2">
                <option id="01" name="missing_area2" value="전체" selected>전체</option>
                <option id="02" name="missing_area2" value="서울">서울</option>
                <option id="03" name="missing_area2" value="경기">경기도</option>
                <option id="04" name="missing_area2" value="강원">강원도</option>
                <option id="05" name="missing_area2" value="전남">전라남도</option>
                <option id="06" name="missing_area2" value="전북">전라북도</option>
                <option id="07" name="missing_area2" value="경남">경상남도</option>
                <option id="08" name="missing_area2" value="경북">경상북도</option>
                <option id="09" name="missing_area2" value="충남">충청남도</option>
                <option id="10" name="missing_area2" value="충북">충청북도</option>
              </select>
            </td>
          </tr>
          <tr>
              <td>실종 기간</td>
              <td>
                  <span>
                    <input type="date" id="missing_time_start" name="missing_time_start">
                  </span>
                  <span>  ~  </span>
                  <span>
                    <input type="date" id="missing_time_end" name="missing_time_end" onchange="setMinValue()">
                  </span>
                  <script>
                    let missingTimeStart = document.getElementById("missing_time_start");
                    let missingTimeEnd = document.getElementById("missing_time_end");

                    function setMinValue() {
                      console.log(missingTimeStart.value, missingTimeEnd.value);
                      if( missingTimeStart.value >= missingTimeEnd.value) {
                        alert('실종 시간보다 이전의 날짜는 설정할 수 없습니다.');
                        missingTimeEnd.value = null;
                      }
                      if( missingTimeStart.value === "" && missingTimeEnd.value != null) {
                        alert('실종 기간 기반 검색을 위해서는 앞에 기간부터 모두 선택해야 합니다.');
                        missingTimeEnd.value = null;
                      }
                    }
                    // function setValue(){
                    //   if (missingTimeStart.value == null) {
                    //     alert('실종 기간 기반 검색을 위해서는 모두 선택해야 합니다.')
                    //   }
                    // }
                  </script>
              </td>
          </tr>



        </tbody>
      </table>
    </div>
    <button type="submit">적용</button> <button type="reset">조건 초기화</button>
  </form>


  <div th:if="${case.getUserId() == user.getId()}">
    <table class="table table-bordered">
      제보 목록
      <!-- CONTENTS !-->
      <thead>
      <tr>
        <th class="col-md-1">번호</th>
        <th class="col-md-4">글제목</th>
        <th class="col-md-3">작성자</th>
        <th class="col-md-2">작성일</th>
        <th class="col-md-2">수정일</th>
      </tr>
      </thead>

      <tbody>
      <!-- CONTENTS !-->
      <tr th:each="report : ${reports}">
        <td th:text="${report.getId()}"></td>
        <td><a th:href="@{/reports/detail/{id}(id=${report.getId()})}" th:text="${report.getWitness_title()}"></a></td>
        <td th:text="${report.getUser().getName()}"></td>
        <!--        <td th:text="${#dates.format(report.getCreatedTime(), 'yyyy-MM-dd')}"></td>-->
      </tr>
      </tbody>
    </table>
  </div>
</div>

  <div th:if="${#lists.size(reports)>0} and ${case.getUserId() != user.getId()}">
    <table class="table table-bordered">
      제보 목록
      <!-- CONTENTS !-->
      <thead>
      <tr>
        <th class="col-md-1">번호</th>
        <th class="col-md-4">글제목</th>
        <th class="col-md-3">작성자</th>
        <th class="col-md-2">작성일</th>
        <th class="col-md-2">수정일</th>
      </tr>
      </thead>

      <tbody>
      <!-- CONTENTS !-->
      <tr th:each="report : ${reports}">
        <td th:text="${report.getId()}"></td>
        <td><a th:href="@{/reports/detail/{id}(id=${report.getId()})}" th:text="${report.getWitness_title()}"></a></td>
        <td th:text="${report.getUser().getName()}"></td>
        <!--        <td th:text="${#dates.format(report.getCreatedTime(), 'yyyy-MM-dd')}"></td>-->
      </tr>
      </tbody>
    </table>
  </div>
</div>
</div>

</body>
</html>