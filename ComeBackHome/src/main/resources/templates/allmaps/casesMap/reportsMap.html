<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ComeBackHome</title>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
            integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script type="text/javascript"
            src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=lez4a7aeq8"></script>
    <!--    <script type="text/javascript" src="../src/caseInfo.js"></script>-->
    <script type="text/javascript"
            src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=lez4a7aeq8&submodules=geocoder"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100vh;
            padding: 0;
            margin: 0;
        }
        body{overflow: hidden}
    </style>
    <link rel="stylesheet" th:href="@{/static/plugins/bootstrap/bootstrap.min.css}">
    <!--   icon-->
    <link rel="stylesheet" th:href="@{/static/plugins/themify-icons/themify-icons.css}">
    <!--Favicon-->
    <link rel="icon" th:href="@{/static/images/earthguard.png}" type="image/x-icon">
    <!-- fonts -->
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel="stylesheet">
    <!-- Main Stylesheet -->
    <link th:href="@{/static/assets/style.css}" rel="stylesheet" media="screen" />


</head>
<body onload="javascript:initMap()">
<header >
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" style="padding-top:5px;padding-bottom: 5px;">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ComeBackHome</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse text-center" id="navbarColor01">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/cases/searchCase">실종자 목록/제보</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/cases/new">실종자 등록하기</a>
                    </li>

                    <li class="nav-item">
                        <a sec:authorize="isAuthenticated()" class="nav-link" href="/users/mypage">마이페이지</a>
                    </li>

                    <li class="nav-item">
                        <a sec:authorize="!isAuthenticated()" class="nav-link" href="/users/login">로그인</a>
                        <a sec:authorize="isAuthenticated()" class="nav-link" href="/users/logout">로그아웃</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>
    <input type="button" class="btn btn-primary" style="margin-top: 10px; margin-left: 15px; margin-bottom: 5px"
           value="시간별 보기" th:onclick="selectTime()">
    <input type="button" class="btn btn-primary" style="margin-top: 10px; margin-left: 15px; margin-bottom: 5px"
           value="장소별 보기" th:onclick="selectPlace()">

    <input type="button" style="position: absolute; right: 1%; margin-top: 10px; margin-bottom: 5px" class="btn btn-primary"
           value="제보 모두보기" th:onclick="|location.href='@{/reports/reportList/{id}(id=${caseEntity.caseId})}'|">
    <section class="container-fluid" style="height: 100%;">
        <div id="map" style="width:75%;height:100%;padding:0;margin:0; float: left"></div>
        <div id="right-list" style="background-color: #9fcdff; height: 100%; width: 25%; float: right">
            <div class="upMenu" style="display: flex; flex-direction: row; margin-top: 10px;">
                <span style="flex: 1; margin-left: 10px; justify-content: space-between">발견시간</span>
                <span style="flex: 1; justify-content: space-between">발견위치</span>
            </div>
            <div style="display: flex; justify-content: left">
                <ul style="list-style:none; margin-right: auto;" class="reportUl">
                </ul>
            </div>
        </div>
    </section>

    <script>
        var map = new naver.maps.Map("map", {
            zoom: 15,
            center: new naver.maps.LatLng(37.3598205, 127.1164068),
            zoomControl: true,
            zoomControlOptions: {
                position: naver.maps.Position.TOP_LEFT,
                style: naver.maps.ZoomControlStyle.SMALL
            }
        });


        var polyline = new naver.maps.Polyline({
            map: map,
            path: []
        });
        var url = window.location.href;
        url = url.split("/");
        url = url[url.length - 1];

        function moveMapCenter(x, y) {
            var center = new naver.maps.LatLng(x, y);
            map.setCenter(center);
            map.setZoom(15);
        }


        function selectTime() {

            $.ajax({
                type: "get",
                url: "report.json/" + url,
                dataType: "json",
                success: function (data) {
                    map = new naver.maps.Map("map", {
                        zoom: 15,
                        center: new naver.maps.LatLng(37.3598205, 127.1164068),
                        zoomControl: true,
                        zoomControlOptions: {
                            position: naver.maps.Position.TOP_LEFT,
                            style: naver.maps.ZoomControlStyle.SMALL
                        }
                    });

                    console.log("통신성공" + url);
                    $('.reportUl').empty();
                    $('.reportUl').css("list-style", "none");
                    $('.upMenu').empty();
                    $('.upMenu').append("<span style=\"flex: 1; margin-left: 10px; justify-content: space-between\">발견시간</span>" +
                        "<span style=\"flex: 1; justify-content: space-between\">발견위치</span>");
                    var newpolyline = new naver.maps.Polyline({
                        map: map,
                        path: []
                    });
                    var path = newpolyline.getPath();

                    $.each(data, function (i) {
                        var x = data[i].witness_lat;
                        var y = data[i].witness_lng;
                        console.log(x, y);
                        path.push(new naver.maps.LatLng(x, y));
                        var marker = new naver.maps.Marker({
                            position: new naver.maps.LatLng(x, y),
                            map: map
                        });

                        str = "<li onclick='moveMapCenter(" + x + "," + y + ")'><span>";
                        str += moment(data[i].witnessTime).format('YYYY-MM-DD') + '</span>';
                        str += '<span style="margin-left: 10px">' + data[i].witness_area + '</span></li>';
                        $('.reportUl').append(str);
                    });


                },
                error: function () {
                    console.log("통신에러");
                }
            })

        }

        function selectPlace() {

            $.ajax({
                type: "get",
                url: "area.json/" + url,
                dataType: "json",
                success: function (data) {
                    map = new naver.maps.Map("map", {
                        zoom: 15,
                        center: new naver.maps.LatLng(37.3598205, 127.1164068),
                        zoomControl: true,
                        zoomControlOptions: {
                            position: naver.maps.Position.TOP_LEFT,
                            style: naver.maps.ZoomControlStyle.SMALL
                        }
                    });


                    $('.reportUl').empty();
                    $('.upMenu').empty();
                    $('.upMenu').append('<span style="margin: auto;">제보 많은 지역</span>');
                    $('.reportUl').css("list-style", "decimal");
                    var colors = ["FireBrick", "Gold", "SeaGreen"];


                    $.each(data, function (key, value) {
                        $.each(value, function (key, value) {
                            console.log("each 문 " + key + value[1] + value[2]);

                            var x, y;
                            var color;
                            if (value[0] > 2) {
                                color = colors[0];
                            } else if (value[0] == 2) {
                                color = colors[1];
                            } else {
                                color = colors[2];
                            }


                            var circle = new naver.maps.Circle({
                                map: map,
                                center: new naver.maps.LatLng(value[1], value[2]),
                                radius: 1000,
                                strokeWeight: 0.4,
                                fillColor: color,
                                fillOpacity: 0.5
                            });

                            str = "<li onclick='moveMapCenter(" + value[1] + "," + value[2] + ")'><span>";
                            str += key + '</span>';
                            str += '<span style="margin-left: 10px">' + value[0] + '개</span></li>';
                            $('.reportUl').append(str);


                        });

                    });


                },
                error: function () {
                    console.log("통신에러");
                }
            })


        }


        function initMap() {

            $.ajax({
                type: "get",
                url: "report.json/" + url,
                dataType: "json",
                success: function (data) {
                    console.log("통신성공" + url);
                    $('.reportUl').empty();
                    var path = polyline.getPath();

                    $.each(data, function (i) {
                        var x = data[i].witness_lat;
                        var y = data[i].witness_lng;
                        console.log(x, y);
                        path.push(new naver.maps.LatLng(x, y));
                        var marker = new naver.maps.Marker({
                            position: new naver.maps.LatLng(x, y),
                            map: map
                        });
                        str = "<li onclick='moveMapCenter(" + x + "," + y + ")'><span>";
                        str += moment(data[i].witnessTime).format('YYYY-MM-DD') + '</span>';
                        str += '<span style="margin-left: 10px">' + data[i].witness_area + '</span></li>';
                        $('.reportUl').append(str);

                    });

                },
                error: function () {
                    console.log("통신에러");
                }
            })


        }


    </script>

</body>
</html>